# Rate of change of CPI by expense category

```{r}
pacman::p_load(tidyverse, rio, janitor, gganimate)
```

```{r}
from_ine <- 
  function(path) {
   import(path) |> 
    as_tibble() |> 
    clean_names() |> 
    select(year = ano,
           month = mes, 
           id = codigo,
           desc = descripcion,
           cpi = rep) |> 
    filter(str_length(id) == 2) |> 
    mutate(id = parse_number(id)) |> 
    mutate(desc = case_when(
      id == 1 ~ 'Alimentos',
      id == 2 ~ 'Licores',
      id == 3 ~ 'Vestimenta',
      id == 4 ~ 'Vivienda',
      id == 5 ~ 'Muebles',
      id == 6 ~ 'Salud',
      id == 7 ~ 'Transporte',
      id == 8 ~ 'Comunicaciones',
      id == 9 ~ 'Recreación',
      id == 10 ~ 'Educación',
      id == 11 ~ 'Restaurantes',
      id == 12 ~ 'Otros',
      TRUE ~ desc
    )) |> 
    mutate(month = as_factor(str_to_title(month)), 
           desc = as_factor(desc)) 
}
```

```{r}
year_2019 <- 'https://www.ine.gob.gt/sistema/uploads/2020/01/07/20200107183958VEdqlo5oBmhO5cvKTQhYRYj2D05gxCla.xls'
year_2020 <- 'https://www.ine.gob.gt/sistema/uploads/2021/01/07/20210107181008hU1E5mBYrw7qBqdWxofaZsj4rULMDiJe.xls'
year_2021 <- 'https://www.ine.gob.gt/sistema/uploads/2022/01/06/20220106212952xoNyfwpIfoBW1kdUPmnw7MVW98ZCTepI.xls'
year_2022 <- 'https://www.ine.gob.gt/sistema/uploads/2022/06/07/20220607184539YNiFivgBo98JEbaVMRUhaFG9wPw9ePe9.xls'
```

```{r}
cpi_raw <- 
  from_ine(year_2019) |> 
  bind_rows(from_ine(year_2020)) |> 
  bind_rows(from_ine(year_2021)) |> 
  bind_rows(from_ine(year_2022))
```

```{r}
cpi <- 
  cpi_raw |> 
  select(!id) |> 
  pivot_wider(names_from = desc, 
              values_from = cpi) |> 
  mutate(across(where(is.numeric), ~ 100 * (log(.) - lag(log(.), 1)))) |> 
  filter(year != 2019) |>
  pivot_longer(!c(year, month), 
               names_to = 'expense', 
               values_to = 'rate') |> 
  mutate(expense = as_factor(expense),
         period = as_factor(paste(month, year)),
         label = paste0(round(rate, 2), '%'))
```

```{r}
cpi |> 
  filter(year == 2022 & month == 'Abril') |> 
  ggplot(aes(expense, rate)) +
  geom_col() +
  geom_text(aes(expense, rate, label = label), 
            vjust = ifelse(cpi[325:336,]$rate < 0, 1.5, -0.5)) +
  labs(subtitle = 'Mayo 2020')
```

```{r}
plot <- 
  cpi |> 
  ggplot(aes(expense, rate)) +
  geom_col() +
  geom_text(aes(expense, rate, label = label), 
            vjust = ifelse(cpi$rate < 0, 1.5, -0.5)) +
  labs(subtitle = "{closest_state}") +
  transition_states(
    period,
    transition_length = 5,
    state_length = 1) +
  enter_grow(size = 1) + 
  exit_shrink(size = 2) +
  ease_aes('elastic-in-out')

animation <- 
  animate(plot, 
          height = 6, width = 6, units = "in", res = 300,
          nframes = 100, fps = 30, renderer = av_renderer())
```

```{r}
anim_save("output.mp4", animation)
```
